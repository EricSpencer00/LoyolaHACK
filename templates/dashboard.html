{% extends 'base.html' %}
{% block title %}Dashboard - CTA Transit Tracker{% endblock %}

{% block content %}
<div class="container my-4">
  <!-- Live Transit Map (the map is featured at the top) -->
  <div class="card mb-4">
    <div class="card-header">
      Live Transit Map
    </div>
    <div class="card-body p-0">
      <div id="map" style="height: 400px;"></div>
    </div>
  </div>

  <div class="row">
    <!-- User Info & Home Location Card -->
    <div class="col-md-6 mb-4">
      <div class="card h-100">
        <div class="card-header">
          My Transit Dashboard
        </div>
        <div class="card-body">
          <h4 class="card-title">
            Welcome, {{ user.phone_number }}
          </h4>
          <p class="card-text">
            Home Location:
            {% if user.home_lat and user.home_lng %}
              ({{ user.home_lat }}, {{ user.home_lng }})
            {% else %}
              <span class="text-danger">Not set</span>
            {% endif %}
          </p>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#homeModal">
            Set Home Location
          </button>
        </div>
      </div>
    </div>
    <!-- Favorite Lines Card -->
    <div class="col-md-6 mb-4">
      <div class="card h-100">
        <div class="card-header">
          Favorite Lines
        </div>
        <div class="card-body">
          <ul class="list-group">
            {% if favorite_lines %}
              {% for line in favorite_lines %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  {{ line }}
                  <button class="btn btn-sm btn-outline-danger" onclick="removeFavorite('{{ line }}')">
                    Remove
                  </button>
                </li>
              {% endfor %}
            {% else %}
              <li class="list-group-item">No favorite lines yet.</li>
            {% endif %}
          </ul>
          <button class="btn btn-success mt-3" data-bs-toggle="modal" data-bs-target="#lineModal">
            Add Favorite Line
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification Settings Card -->
  <div class="card mb-4">
    <div class="card-header">
      Notification Settings
    </div>
    <div class="card-body">
      <p class="card-text">
        Set alerts for your favorite lines.
      </p>
      <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#notificationModal">
        Manage Notifications
      </button>
    </div>
  </div>
</div>

<!-- Modals -->
<!-- Home Location Modal -->
<div class="modal fade" id="homeModal" tabindex="-1" aria-labelledby="homeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="homeForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="homeModalLabel">Set Home Location</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="homeLat" class="form-label">Latitude</label>
          <input type="text" class="form-control" id="homeLat" placeholder="e.g., 41.8781">
        </div>
        <div class="mb-3">
          <label for="homeLng" class="form-label">Longitude</label>
          <input type="text" class="form-control" id="homeLng" placeholder="e.g., -87.6298">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Save Home Location</button>
      </div>
    </form>
  </div>
</div>

<!-- Add Favorite Line Modal -->
<div class="modal fade" id="lineModal" tabindex="-1" aria-labelledby="lineModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="lineForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="lineModalLabel">Add Favorite Line</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="lineInput" class="form-label">Transit Line</label>
          <input type="text" class="form-control" id="lineInput" placeholder="e.g., Blue Line">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Add Favorite</button>
      </div>
    </form>
  </div>
</div>

<div class="mb-3">
  <label for="routeSearch" class="form-label">Search for nearby routes</label>
  <input type="text" id="routeSearch" class="form-control" placeholder="Enter a transit line or keyword">
</div>
<button id="searchRoutes" class="btn btn-info mb-3">Search Routes</button>
<ul id="searchResults" class="list-group"></ul>

<!-- Notification Settings Modal -->
<div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="notificationForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="notificationModalLabel">Notification Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="notificationTime" class="form-label">Notify me (minutes before transit)</label>
          <input type="number" class="form-control" id="notificationTime" placeholder="e.g., 10">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-warning">Save Notifications</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize user home location and map center
var userHome = {{ {'lat': user.home_lat, 'lng': user.home_lng} | tojson }};
var defaultCenter = [41.8781, -87.6298];
var mapCenter = (userHome && userHome.lat && userHome.lng) ? [userHome.lat, userHome.lng] : defaultCenter;

// Initialize the map with CartoDB Positron tiles
var map = L.map('map').setView(mapCenter, 13);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://carto.com/">CartoDB</a>',
  maxZoom: 19
}).addTo(map);

// Create a draggable home marker
var homeMarker = L.marker(mapCenter, { draggable: true }).addTo(map);
homeMarker.bindPopup("Drag me to set your home location.").openPopup();
homeMarker.on('dragend', function(e) {
  var newPos = e.target.getLatLng();
  fetch('/api/set_home', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ lat: newPos.lat, lng: newPos.lng })
  })
  .then(response => response.json())
  .then(data => { alert(data.message); })
  .catch(console.error);
});

// Create emoji markers for transit vehicles
var busIcon = L.divIcon({ html: 'ðŸšŒ', className: 'emoji-icon', iconSize: [30, 30] });
var trainIcon = L.divIcon({ html: 'ðŸš†', className: 'emoji-icon', iconSize: [30, 30] });

// Layer groups for transit markers
var busLayer = L.layerGroup();
var trainLayer = L.layerGroup();

// Fetch and display bus data
fetch('/api/realtime?type=bus')
  .then(response => response.json())
  .then(data => {
    data.forEach(function(item) {
      L.marker([item.lat, item.lng], { icon: busIcon })
        .bindPopup("<strong>Bus " + item.line + "</strong>")
        .addTo(busLayer);
    });
  });

// Fetch and display train data
fetch('/api/realtime?type=train')
  .then(response => response.json())
  .then(data => {
    data.forEach(function(item) {
      L.marker([item.lat, item.lng], { icon: trainIcon })
        .bindPopup("<strong>Train " + item.line + "</strong>")
        .addTo(trainLayer);
    });
  });

// Add layers control and default layers to map
var overlays = { "Buses": busLayer, "Trains": trainLayer };
L.control.layers(null, overlays).addTo(map);
busLayer.addTo(map);
trainLayer.addTo(map);

// Draw a sample transit route (polyline) with custom styling
var sampleRoute = [
  [41.881, -87.627],
  [41.882, -87.630],
  [41.883, -87.635],
  [41.885, -87.640]
];
var routeStyle = { color: '#FF5733', weight: 4, dashArray: '5, 10' };
L.polyline(sampleRoute, routeStyle).addTo(map);

// Function to update GTFS shapes based on viewport
function updateShapes() {
  var bounds = map.getBounds();
  var sw = bounds.getSouthWest();
  var ne = bounds.getNorthEast();

  fetch(`/api/gtfs_shapes?sw_lat=${sw.lat}&sw_lng=${sw.lng}&ne_lat=${ne.lat}&ne_lng=${ne.lng}`)
    .then(response => response.json())
    .then(data => {
      // For production, store and remove previous shape layers before adding new ones.
      Object.keys(data).forEach(function(shapeId) {
        var points = data[shapeId].map(pt => [pt.lat, pt.lon]);
        L.polyline(points, { color: 'black', weight: 4, opacity: 1 }).addTo(map);
      });
    })
    .catch(console.error);
}

// Update shapes on map moveend
map.on('moveend', updateShapes);

// Handle form submissions and search functionality
document.getElementById('homeForm').addEventListener('submit', function(e) {
  e.preventDefault();
  var lat = document.getElementById('homeLat').value;
  var lng = document.getElementById('homeLng').value;
  fetch('/api/set_home', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ lat: lat, lng: lng })
  })
  .then(response => response.json())
  .then(data => { alert(data.message); location.reload(); })
  .catch(console.error);
});

document.getElementById('lineForm').addEventListener('submit', function(e) {
  e.preventDefault();
  var line = document.getElementById('lineInput').value;
  fetch('/api/add_favorite', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ line: line })
  })
  .then(response => response.json())
  .then(function(data) {
    if (data.status === 'success') {
      alert('Favorite added'); location.reload();
    } else {
      alert(data.message);
    }
  })
  .catch(console.error);
});

document.getElementById('notificationForm').addEventListener('submit', function(e) {
  e.preventDefault();
  var time = document.getElementById('notificationTime').value;
  fetch('/api/set_notification', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ notification_settings: { time: time } })
  })
  .then(response => response.json())
  .then(function(data) { alert(data.message); location.reload(); })
  .catch(console.error);
});

function removeFavorite(line) {
  fetch('/api/remove_favorite', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ line: line })
  })
  .then(response => response.json())
  .then(function(data) {
    if (data.status === 'success') {
      alert('Favorite removed'); location.reload();
    } else {
      alert(data.message);
    }
  })
  .catch(console.error);
}

document.getElementById('searchRoutes').addEventListener('click', function() {
  var query = document.getElementById('routeSearch').value;
  var coords = (userHome && userHome.lat && userHome.lng) ? { lat: userHome.lat, lng: userHome.lng } : { lat: defaultCenter[0], lng: defaultCenter[1] };
  fetch(`/api/search_routes?lat=${coords.lat}&lng=${coords.lng}&q=${query}`)
    .then(response => response.json())
    .then(function(data) {
      var resultsList = document.getElementById('searchResults');
      resultsList.innerHTML = '';
      if (data.length) {
        data.forEach(function(route) {
          var li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = route.name + ' (' + route.distance.toFixed(2) + ' miles)';
          var addBtn = document.createElement('button');
          addBtn.className = 'btn btn-sm btn-success float-end';
          addBtn.textContent = 'Add';
          addBtn.onclick = function() {
            fetch('/api/add_favorite', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ line: route.name })
            })
            .then(resp => resp.json())
            .then(function(res) { alert(res.message); location.reload(); })
            .catch(console.error);
          };
          li.appendChild(addBtn);
          resultsList.appendChild(li);
        });
      } else {
        resultsList.innerHTML = '<li class="list-group-item">No routes found within 1.5 miles.</li>';
      }
    })
    .catch(console.error);
});
</script>
{% endblock %}
